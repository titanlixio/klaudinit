#jinja2: trim_blocks:False
# Generated by ansible

global
  maxconn 4096
  user nobody
  group nobody
  daemon
  tune.maxrewrite 16384000
  tune.bufsize 32768000

defaults 
  mode tcp
  retries 3
  timeout connect 3s
# http://stackoverflow.com/questions/32634980
  timeout server 200s
  timeout client 200s
 

{% for rule in port_rules %}
# {{rule.name}}
{% for port in rule.ports %}
# {{port.name}}
frontend f-{{port.name}}-tcp-{{port.dest}}
  bind *:{{port.dest}} name clear
  default_backend b-{{port.name}}-tcp-{{port.dest}}
    
backend  b-{{port.name}}-tcp-{{port.dest}}
  balance roundrobin
  {% for vm in rule.vms -%}
  server  {{vm.name}} {{vm.addr}}:{{port.src}} check inter 1s
  {% endfor %}
{% endfor %}
{% endfor %}
